<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedVision AI - Surgical Navigation HUD</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10B981;       /* Vibrant Emerald Green */
            --primary-light: #34D399; /* Lighter Emerald for hover */
            --secondary: #E5E7EB;     /* Light Gray for accents */
            --accent: #5EEAD4;        /* Bright Teal accent */
            --dark-bg: #111827;       /* Very Dark Blue/Gray, almost black */
            --surface-bg: #1F2937;    /* Darker Gray for cards */
            --border-color: #374151;  /* Muted Gray for borders */
            --text-light: #F9FAFB;    /* Near White */
            --text-medium: #9CA3AF;   /* Lighter Gray */
            --danger: #EF4444;        /* Strong Red */
            --warning: #F59E0B;       /* Amber/Yellow */
            --success: #10B981;       /* Same as primary green */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
       body {
    font-family: 'Inter', sans-serif;
    background-color: var(--dark-bg);
    color: var(--text-light);
    line-height: 1.7;
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
}
        .container { max-width: 1800px; margin: 0 auto; padding: 0 2rem; }

        /* PASTE THIS ENTIRE BLOCK into simulate.html's style tag */

header {
    background: var(--surface-bg);
    color: white;
    padding: 1.2rem 0;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    border-bottom: 1px solid var(--border-color);
}
.header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--text-light);
    text-decoration: none;
}
.logo-icon {
    font-size: 2rem;
    color: var(--primary);
}
nav ul {
    display: flex;
    list-style: none;
    gap: 2.5rem;
}
nav a {
    color: var(--text-medium);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
    padding: 0.6rem 0.2rem;
    position: relative;
}
nav a::before {
    content: '';
    position: absolute;
    width: 0;
    height: 3px;
    bottom: -5px;
    left: 0;
    background-color: var(--primary);
    transition: width 0.2s ease;
    border-radius: 2px;
}
nav a:hover {
    color: white;
}
nav a:hover::before, nav a.active::before {
    width: 100%;
}
nav a.active {
    color: white;
}
.nav-link {
    color: var(--text-medium);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.nav-link:hover {
    color: var(--primary-light);
}
/* Add this CSS inside the <style> tag in simulate.html */
.preview-container {
    display: flex;
    justify-content: center;
    width: 100%;
}
.preview-image-wrapper {
    position: relative;
    width: 200px;
    height: 150px;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}
.preview-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.remove-image {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    background-color: rgba(231, 76, 60, 0.8);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.2s;
}
.remove-image:hover {
    opacity: 1;
}
.mobile-menu-btn { display: none; }

/* Styles for mobile responsiveness */
@media (max-width: 768px) {
    .mobile-menu-btn {
        display: block;
        background: none;
        border: none;
        color: white;
        font-size: 1.8rem;
        cursor: pointer;
    }
    nav {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--surface-bg);
        padding: 1rem;
        box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }
    nav.active {
        display: block;
    }
    nav ul {
        flex-direction: column;
        gap: 0.8rem;
    }
    nav a {
        display: block;
        text-align: center;
    }
}
        .upload-section { background-color: var(--surface-bg); border-radius: 20px; padding: 3rem; margin: 2rem auto 3rem; max-width: 1000px; border: 1px solid var(--border-color); }
        .upload-container { display: flex; flex-direction: column; align-items: center; gap: 2rem; }
        .dropzone { width: 100%; max-width: 700px; height: 150px; border-radius: 16px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; background: var(--dark-bg); border: 2px dashed var(--border-color); transition: background-color 0.2s, border-color 0.2s; }
        .dropzone:hover { background-color: #374151; border-color: var(--primary); }
        .analyze-btn { background: var(--primary); color: var(--dark-bg); border: none; padding: 1rem 3rem; font-size: 1.1rem; font-weight: 600; border-radius: 12px; cursor: pointer; transition: background-color 0.2s; }
        .analyze-btn:hover { background-color: var(--primary-light); }

        .navigation-section { display: none; }
        .navigation-container { display: grid; grid-template-columns: 4fr 1fr; gap: 2rem; align-items: flex-start; }
        .canvas-container { border: 2px solid var(--border-color); border-radius: 16px; background-color: #000; overflow: hidden; position: relative; }
        #navigationCanvas { display: block; width: 100%; height: auto; background-color: #000; }

        .controls-panel { display: flex; flex-direction: column; gap: 1.5rem; }
        .data-card { background: var(--dark-bg); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); }
        .data-card h3 { color: var(--primary-light); margin-bottom: 1rem; }
        .action-btn { background: var(--accent); color: var(--dark-bg); border: none; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 8px; cursor: pointer; width: 100%; transition: background-color 0.2s; }
        .action-btn:disabled { background: var(--border-color); color: var(--text-medium); cursor: not-allowed; }

        /* --- NEW: Reset Button Style --- */
        .reset-btn {
            margin-top: 1rem;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-medium);
        }
        .reset-btn:hover {
            background: var(--border-color);
            color: var(--text-light);
        }

        .movement-log-list { list-style: none; padding: 0; margin-top: 1rem; max-height: 400px; overflow-y: auto; font-family: 'Roboto Mono', monospace; }
        .movement-log-item { padding: 0.8rem; border-radius: 6px; margin-bottom: 0.5rem; font-size: 0.9rem; border-left: 4px solid; }
        .log-safe { border-color: var(--success); } .log-caution { border-color: var(--warning); } .log-warning { border-color: var(--danger); }
        .log-critical { border-color: var(--danger); background-color: rgba(239, 68, 68, 0.1); font-weight: bold; }

        #aiAssistantText { font-family: 'Roboto Mono', monospace; color: var(--primary-light); min-height: 50px; }
        .typing-cursor { display: inline-block; width: 8px; height: 1.2rem; background-color: var(--primary-light); animation: blink 1s infinite; vertical-align: middle; }
        @keyframes blink { 50% { opacity: 0; } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .modal-content { background: var(--surface-bg); color: var(--text-light); border-radius: 16px; padding: 2rem; width: 90%; max-width: 700px; border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-content h2 { color: var(--primary-light); margin-bottom: 1.5rem; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; font-family: 'Roboto Mono', monospace; }
        .summary-item { background: var(--dark-bg); padding: 1rem; border-radius: 8px; }
        .summary-item .label { color: var(--text-medium); font-size: 0.9rem; }
        .summary-item .value { font-size: 1.2rem; font-weight: bold; }
        #geminiSummary { border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1.5rem; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.9); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid var(--border-color); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

/* DELETE the old 'footer' styles in simulate.html and REPLACE with this block */
footer {
            background: #08121e;
            color: white;
            padding: 4rem 0 2rem;
            border-top: 1px solid var(--border-color);
        }

        .footer-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 3rem; margin-bottom: 3rem; }
        .footer-column h3 { font-size: 1.4rem; margin-bottom: 1.8rem; padding-bottom: 12px; color: white; position: relative; }
        .footer-column h3::after { content: ''; position: absolute; width: 50px; height: 3px; background: var(--primary); bottom: 0; left: 0; border-radius: 3px; }

        .footer-logo { color: var(--text-light); }
        .footer-description { color: var(--text-medium); margin-bottom: 1.5rem; }

        .social-links { display: flex; gap: 1.2rem; margin-top: 1.5rem; }
        .social-link { display: flex; align-items: center; justify-content: center; width: 45px; height: 45px; border-radius: 50%; color: var(--text-medium); transition: all var(--speed-normal) ease; border: 1px solid var(--border-color); }
        .social-link:hover { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-3px); }

        .footer-links { list-style: none; }
        .footer-links li { margin-bottom: 1rem; }
        .footer-links a { color: var(--text-medium); text-decoration: none; transition: all var(--speed-fast) ease; }
        .footer-links a:hover { color: var(--primary-light); transform: translateX(5px); }

        .contact-info { list-style: none; }
        .contact-info li { margin-bottom: 1.2rem; display: flex; align-items: flex-start; gap: 1rem; color: var(--text-medium); }
        .contact-info i { color: var(--primary); font-size: 1.2rem; margin-top: 3px; }

        .copyright { text-align: center; padding-top: 2rem; border-top: 1px solid var(--border-color); font-size: 0.95rem; color: var(--text-dark); }
        .copyright a { color: var(--text-medium); text-decoration: none; }
        .copyright a:hover { color: var(--primary); }


    </style>
</head>
<body>
 <header>
    <div class="container header-container">
        <a href="/" class="logo">
            <i class="fas fa-eye logo-icon"></i>
            <span>MedVision AI</span>
        </a>
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
        <nav id="mainNav">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/#analyze">Upload & Scan</a></li>
                <li><a href="/#features">Technology</a></li>
                <li><a href="/simulate" class="active">Simulation</a></li>
            </ul>
        </nav>
    </div>
</header>
    <main class="container">
        <section class="upload-section" id="analyze">
             <div class="upload-container">
                <div class="dropzone" id="dropzone"><p>Drop your medical scan here, or click to browse files</p><small>Accepted Formats: JPG, PNG, JPEG (Up to 16MB)</small></div>
                 <div class="preview-container" id="previewContainer" style="display: none;">
        <div class="preview-image-wrapper">
            <img id="imagePreview" class="preview-image" src="" alt="Scan Preview">
            <div class="remove-image" id="removeImage">
                <i class="fas fa-times"></i>
            </div>
        </div>
    </div>
                <input type="file" id="fileInput" accept="image/png, image/jpeg, image/jpg" hidden>
                <select id="modelSelect" style="width: 700px; max-width:100%; padding: 10px; background: var(--dark-bg); color:white; border: 1px solid var(--border-color);">
                    <option value="liver">Liver Tumour</option>
                    <option value="brain_mri">Brain Tumour</option>
                    <option value="eye">Eye Conditions</option>
                    <option value="kidney">Kidney Stone</option>
                    <option value="lung">Lung Cancer</option>
                </select>
                <button class="analyze-btn" id="analyzeBtn">Start Simulation</button>
            </div>
        </section>
        <section class="navigation-section" id="navigationSection">
            <div class="navigation-container">
                <div class="canvas-container"><canvas id="navigationCanvas" width="1400" height="1050"></canvas></div>
                <div class="controls-panel">
                    <div class="data-card">
                        <h3><i class="fas fa-tools"></i> Simulation Control</h3>
                        <button class="action-btn" id="startSimBtn" disabled>Initialize</button>
                        <button class="action-btn reset-btn" id="resetBtn">New Analysis</button>
                    </div>
                    <div class="data-card">
                        <h3><i class="fas fa-robot"></i> AI Surgical Assistant</h3>
                        <div id="aiAssistantText">Awaiting procedure start...</div>
                    </div>
                    <div class="data-card">
                        <h3><i class="fas fa-history"></i> Operation Log</h3>
                        <ul class="movement-log-list" id="movementLogList"></ul>
                    </div>
                </div>
            </div>
        </section>
    </main>

   <footer id="contact">
    <div class="container">
        <div class="footer-container">
            <div class="footer-column">
                <div class="logo footer-logo">
                    <i class="fas fa-eye logo-icon"></i>
                    <span>MedVision AI</span>
                </div>
                <p class="footer-description">Advancing medical diagnostics with cutting-edge AI to provide deeper insights from medical imagery.</p>
                <div class="social-links">
                    <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-linkedin-in"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-github"></i></a>
                </div>
            </div>
            <div class="footer-column">
                <h3>Navigation</h3>
                <ul class="footer-links">
                    <li><a href="/">Home</a></li>
                    <li><a href="/#analyze">Upload & Scan</a></li>
                    <li><a href="/#features">Capabilities</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Get in Touch</h3>
                <ul class="contact-info">
                    <li><i class="fas fa-envelope"></i><span>piyushmaurya132@gmail.com</span></li>
                    <li><i class="fas fa-map-marker-alt"></i><span>VIT Chennai</span></li>
                    <li><i class="fas fa-clock"></i><span>Hours: 9:00 - 17:00, Mon-Fri</span></li>
                </ul>
            </div>
        </div>
        <div class="copyright">
            <p><a href="#">Privacy Statement</a> | <a href="#">Usage Terms</a></p>
        </div>
    </div>
</footer>
    <div class="modal-overlay" id="summaryModal">
        <div class="modal-content">
            <h2>Post-Procedure Report</h2>
            <div class="summary-grid">
                <div class="summary-item"><span class="label">Total Maneuvers</span><div id="summaryMoves" class="value"></div></div>
                <div class="summary-item"><span class="label">No-Fly Zone Breaches</span><div id="summaryNfz" class="value"></div></div>
                <div class="summary-item" style="grid-column: 1 / -1;"><span class="label">Severity Breakdown</span><div id="summarySeverity" class="value"></div></div>
            </div>
            <div id="geminiSummary">
                <h3><i class="fas fa-comment-medical"></i> AI Assessment</h3>
                <p id="geminiSummaryText"></p>
            </div>
            <button class="action-btn" style="margin-top: 2rem;" onclick="document.getElementById('summaryModal').style.display='none'">Close Report</button>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>

    <script>
       // REPLACE the old dropzone/fileInput listeners with this block at the top of your <script> tag

const previewContainer = document.getElementById('previewContainer');
const imagePreview = document.getElementById('imagePreview');
const removeImage = document.getElementById('removeImage');

dropzone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => handleSimFileSelect(e.target.files));
dropzone.addEventListener('dragover', (e) => { e.preventDefault(); }); // Prevents browser from opening file
dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    handleSimFileSelect(e.dataTransfer.files);
});

removeImage.addEventListener('click', e => {
    e.stopPropagation();
    fileInput.value = '';
    previewContainer.style.display = 'none';
    dropzone.style.display = 'flex';
    // This new line resets the text
    dropzone.innerHTML = `<i class="fas fa-cloud-upload-alt"></i><p>Drop your medical scan here, or click to browse files</p><small>Accepted Formats: JPG, PNG, JPEG (Up to 16MB)</small>`;
    analyzeBtn.disabled = true;
});
function handleSimFileSelect(files) {
    if (!files || files.length === 0) return;
    const file = files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
        imagePreview.src = e.target.result;
        previewContainer.style.display = 'flex';
        dropzone.style.display = 'none';
        analyzeBtn.disabled = false;
    };
    reader.readAsDataURL(file);
}

// Your existing 'analyzeBtn.addEventListener' and other code should continue below this
// ...
        const analyzeBtn = document.getElementById('analyzeBtn');
        const canvas = document.getElementById('navigationCanvas');
        const ctx = canvas.getContext('2d');
        const startSimBtn = document.getElementById('startSimBtn');
        const logList = document.getElementById('movementLogList');
        const aiAssistantText = document.getElementById('aiAssistantText');
        // MODIFIED: Added Reset Button Constant
        const resetBtn = document.getElementById('resetBtn');

        const styles = getComputedStyle(document.documentElement);
        const THEME = {
            PRIMARY: styles.getPropertyValue('--primary').trim(),
            PRIMARY_LIGHT: styles.getPropertyValue('--primary-light').trim(),
            ACCENT: styles.getPropertyValue('--accent').trim(),
            SECONDARY: styles.getPropertyValue('--secondary').trim(),
            DANGER: styles.getPropertyValue('--danger').trim(),
            WARNING: styles.getPropertyValue('--warning').trim(),
            SUCCESS: styles.getPropertyValue('--success').trim(),
            SURFACE: 'rgba(31, 41, 55, 0.85)',
            TEXT_LIGHT: styles.getPropertyValue('--text-light').trim(),
            NFZ_FILL: 'rgba(239, 68, 68, 0.1)',
            NFZ_STROKE: 'rgba(239, 68, 68, 0.4)',
        };

        let image = new Image();
        let primaryTargetBbox, detectedClassName;
        let scanlineY = 0, lastTimestamp = 0, isLoopRunning = false;

        let renderState = {
            status: 'AWAITING INIT', statusColor: '#888',
            view: { x: canvas.width / 2, y: canvas.height / 2, scale: 1.0 },
            movementPoints: [], secondaryTargets: [], noFlyZones: [],
            locateProgress: 0, alertOpacity: 0, alertColor: '', hud: {},
            procedureAnalytics: { moves: 0, nfzBreaches: 0, severities: { safe: 0, caution: 0, warning: 0, critical: 0 } }
        };

        const PIXELS_PER_MM = 5;
        const SIMULATION_STEPS = 5;
        const SEVERITY_THRESHOLDS = { caution: 10, warning: 25 };
        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));


        analyzeBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) { alert('Please select an image file first.'); return; }
            const formData = new FormData();
            formData.append('file', file);
            formData.append('model', document.getElementById('modelSelect').value);
            document.getElementById('loadingOverlay').style.display = 'flex';
            fetch('/detect_for_simulation', { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    if (data.error) { alert(`Error: ${data.error}`); return; }
                    initializeNavigation(data);
                })
                .catch(error => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    console.error('Error:', error);
                    alert('An unexpected error occurred.');
                });
        });
        startSimBtn.addEventListener('click', runSimulation);

        // MODIFIED: Added Event Listener for Reset Button
        resetBtn.addEventListener('click', () => {
            location.reload();
        });


        function initializeNavigation(data) {
            const allTargets = data.detections.filter(d => "tumor tumour stone".includes(d.class));
            if (allTargets.length === 0) { alert('No primary target could be detected.'); return; }
            allTargets.sort((a, b) => ((b.bbox[2] - b.bbox[0]) * (b.bbox[3] - b.bbox[1])) - ((a.bbox[2] - a.bbox[0]) * (a.bbox[3] - a.bbox[1])));
            const primaryTarget = allTargets[0];
            detectedClassName = primaryTarget.class;
            const bbox = primaryTarget.bbox;
            primaryTargetBbox = {
                x: bbox[0], y: bbox[1], width: bbox[2] - bbox[0], height: bbox[3] - bbox[1],
                centerX: bbox[0] + (bbox[2] - bbox[0]) / 2, centerY: bbox[1] + (bbox[3] - bbox[1]) / 2,
            };

            logList.innerHTML = '';
            image.src = data.original_image;
            image.onload = async () => {
                const initialScale = Math.min(canvas.width / image.width, canvas.height / image.height) * 0.9;

                renderState = {
                    status: 'INITIALIZING...', statusColor: 'var(--text-medium)',
                    view: { x: canvas.width / 2, y: canvas.height / 2, scale: initialScale },
                    movementPoints: [{ x: canvas.width / 2, y: canvas.height / 2, scale: initialScale }],
                    secondaryTargets: allTargets.slice(1),
                    noFlyZones: [
                        { x: primaryTargetBbox.centerX - 150, y: primaryTargetBbox.centerY - 50, radius: 40 },
                        { x: primaryTargetBbox.centerX + 100, y: primaryTargetBbox.centerY + 120, radius: 50 }
                    ],
                    locateProgress: 0, alertOpacity: 0, alertColor: '', hud: {},
                    procedureAnalytics: { moves: 0, nfzBreaches: 0, severities: { safe: 0, caution: 0, warning: 0, critical: 0 } }
                };

                document.getElementById('navigationSection').style.display = 'grid';
                document.getElementById('analyze').style.display = 'none';
                await displayInitialDetection();
                startSimBtn.disabled = false;
                startSimBtn.textContent = "Start Simulation";
                if (!isLoopRunning) { isLoopRunning = true; requestAnimationFrame(gameLoop); }
            };
        }

        async function displayInitialDetection() {
            renderState.status = `${detectedClassName.toUpperCase()} DETECTED (PRIMARY)`;
            renderState.statusColor = THEME.PRIMARY;
            await sleep(2500);
            renderState.status = 'READY';
            renderState.statusColor = THEME.SUCCESS;
        }

        async function runSimulation() {
            startSimBtn.disabled = true;
            logList.innerHTML = '';
            await typeMessage(aiAssistantText, "Procedure starting. Calibrating initial position.");

            const alertPlan = ['warning', 'safe', 'caution', 'caution', 'caution'];
            for (let i = alertPlan.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [alertPlan[i], alertPlan[j]] = [alertPlan[j], alertPlan[i]];
            }

            for (let i = 0; i < SIMULATION_STEPS; i++) {
                const previousPoint = renderState.movementPoints[renderState.movementPoints.length - 1];

                renderState.status = "LOCATING PRIMARY TARGET...";
                renderState.statusColor = THEME.PRIMARY_LIGHT;
                await animateProgress(p => renderState.locateProgress = p, 1500);

                renderState.status = "TARGET LOCKED";
                renderState.statusColor = THEME.DANGER;
                await sleep(1000);
                renderState.locateProgress = 0;

                renderState.status = "REPOSITIONING...";
                renderState.statusColor = THEME.ACCENT;

                const targetSeverity = alertPlan[i];
                const { dx, dy } = generateMovementForSeverity(targetSeverity);
                const nextPoint = {
                    x: previousPoint.x + dx,
                    y: previousPoint.y + dy,
                    scale: previousPoint.scale * (Math.random() * 0.2 + 0.9)
                };

                await animateView(previousPoint, nextPoint, 800);
                renderState.movementPoints.push(nextPoint);

                const nfzBreach = checkNfzIntersection(nextPoint);
                if (nfzBreach) { renderState.procedureAnalytics.nfzBreaches++; }

                updateAndLog(previousPoint, nextPoint, i + 1, nfzBreach);
                await triggerAlert(renderState.hud.severity);
                await getSurgicalAdvice(nfzBreach);
                await sleep(5000);
            }
            renderState.status = "PROCEDURE COMPLETE";
            renderState.statusColor = THEME.SUCCESS;
            startSimBtn.textContent = "Run Again";
            startSimBtn.disabled = false;
            await showProcedureSummary();
        }

        async function showProcedureSummary() {
            const pa = renderState.procedureAnalytics;
            document.getElementById('summaryMoves').textContent = pa.moves;
            document.getElementById('summaryNfz').textContent = pa.nfzBreaches;
            const severityText = `${pa.severities.safe} Safe | ${pa.severities.caution} Caution | ${pa.severities.warning} Warning | ${pa.severities.critical} Critical`;
            document.getElementById('summarySeverity').textContent = severityText;

            const context = {
                target_class: detectedClassName,
                total_moves: pa.moves,
                nfz_breaches: pa.nfzBreaches,
                severity_breakdown: severityText.replace(/ \| /g, ', ')
            };

            await typeMessage(document.getElementById('geminiSummaryText'), "Generating AI Assessment...");
            try {
                const response = await fetch('/get_procedure_summary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(context)
                });
                const data = await response.json();
                await typeMessage(document.getElementById('geminiSummaryText'), data.summary);
            } catch (e) { await typeMessage(document.getElementById('geminiSummaryText'), "Could not generate summary."); }

            document.getElementById('summaryModal').style.display = 'flex';
        }

        function generateMovementForSeverity(severity) {
            let min_dist_mm = 0, max_dist_mm = 0;
            if (severity === 'safe') { min_dist_mm = 1; max_dist_mm = SEVERITY_THRESHOLDS.caution; }
            else if (severity === 'caution') { min_dist_mm = SEVERITY_THRESHOLDS.caution; max_dist_mm = SEVERITY_THRESHOLDS.warning; }
            else { min_dist_mm = SEVERITY_THRESHOLDS.warning; max_dist_mm = 40; }
            const target_dist_px = (Math.random() * (max_dist_mm - min_dist_mm) + min_dist_mm) * PIXELS_PER_MM;
            const angle = Math.random() * 2 * Math.PI;
            return { dx: Math.cos(angle) * target_dist_px, dy: Math.sin(angle) * target_dist_px };
        }

        async function getSurgicalAdvice(nfzBreach = false) {
            const context = {
                target_class: detectedClassName,
                distance: renderState.hud.distance.split(' ')[0],
                severity: renderState.hud.severity,
                nfz_breach: nfzBreach ? 'just' : 'not'
            };
            await typeMessage(aiAssistantText, "AI analyzing...");
            try {
                const response = await fetch('/get_gemini_advice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(context)
                });
                const data = await response.json();
                await typeMessage(aiAssistantText, data.advice);
            } catch (e) { await typeMessage(aiAssistantText, "Assistant connection error."); }
        }

        function typeMessage(element, text) {
            return new Promise(resolve => {
                element.innerHTML = ""; let i = 0;
                const interval = setInterval(() => {
                    if (i < text.length) { element.innerHTML += text.charAt(i); i++; }
                    else { clearInterval(interval); element.querySelector('.typing-cursor')?.remove(); resolve(); }
                }, 30);
                const cursor = document.createElement('span');
                cursor.className = 'typing-cursor';
                element.appendChild(cursor);
            });
        }

        function gameLoop(timestamp) {
            if(!isLoopRunning) return;
            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;
            if(deltaTime > 0) scanlineY = (scanlineY + deltaTime * 0.05) % canvas.height;
            draw();
            requestAnimationFrame(gameLoop);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (!primaryTargetBbox) return;

            ctx.save();
            ctx.translate(renderState.view.x, renderState.view.y);
            ctx.scale(renderState.view.scale, renderState.view.scale);
            ctx.translate(-primaryTargetBbox.centerX, -primaryTargetBbox.centerY);
            ctx.drawImage(image, 0, 0);

            ctx.lineWidth = 2 / renderState.view.scale;
            ctx.fillStyle = `rgba(74, 144, 226, 0.3)`;
            ctx.strokeStyle = `rgba(74, 144, 226, 0.8)`;
            for (const target of renderState.secondaryTargets) {
                const bbox = target.bbox;
                ctx.fillRect(bbox[0], bbox[1], bbox[2] - bbox[0], bbox[3] - bbox[1]);
                ctx.strokeRect(bbox[0], bbox[1], bbox[2] - bbox[0], bbox[3] - bbox[1]);
            }

            ctx.fillStyle = `rgba(239, 68, 68, 0.3)`;
            ctx.strokeStyle = `rgba(239, 68, 68, 0.8)`;
            ctx.fillRect(primaryTargetBbox.x, primaryTargetBbox.y, primaryTargetBbox.width, primaryTargetBbox.height);
            ctx.strokeRect(primaryTargetBbox.x, primaryTargetBbox.y, primaryTargetBbox.width, primaryTargetBbox.height);

            ctx.fillStyle = THEME.NFZ_FILL;
            ctx.strokeStyle = THEME.NFZ_STROKE;
            for (const zone of renderState.noFlyZones) {
                ctx.beginPath();
                ctx.arc(zone.x, zone.y, zone.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
            }
            ctx.restore();

            drawVignette();
            drawScanlines();

            if (renderState.alertOpacity > 0) {
                ctx.globalAlpha = renderState.alertOpacity;
                ctx.strokeStyle = renderState.alertColor;
                ctx.lineWidth = 20;
                ctx.strokeRect(0, 0, canvas.width, canvas.height);
                ctx.globalAlpha = 1.0;
            }

            for(let i = 1; i < renderState.movementPoints.length; i++) {
                const isLast = (i === renderState.movementPoints.length - 1);
                drawMeasurementVector(renderState.movementPoints[i-1], renderState.movementPoints[i], isLast);
            }
            drawReticle(renderState.view.x, renderState.view.y, renderState.locateProgress);
            drawHUD();
        }

        function animateProgress(updateCallback, duration) {
            return new Promise(resolve => {
                let startTime = null;
                const step = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const progress = Math.min((timestamp - startTime) / duration, 1);
                    updateCallback(progress);
                    if (progress < 1) requestAnimationFrame(step);
                    else resolve();
                };
                requestAnimationFrame(step);
            });
        }

        function animateView(start, end, duration) {
            const updateCallback = (progress) => {
                renderState.view.x = start.x + (end.x - start.x) * progress;
                renderState.view.y = start.y + (end.y - start.y) * progress;
                renderState.view.scale = start.scale + (end.scale - start.scale) * progress;
            };
            return animateProgress(updateCallback, duration);
        }

        function triggerAlert(severity) {
            const colors = { safe: THEME.SUCCESS, caution: THEME.WARNING, warning: THEME.DANGER, critical: THEME.DANGER };
            renderState.alertColor = colors[severity];
            return animateProgress(p => renderState.alertOpacity = Math.sin(p * Math.PI), 800);
        }

        function checkNfzIntersection(p2) {
            const view = renderState.view;
            for (const zone of renderState.noFlyZones) {
                const zoneCanvasSpace = {
                    x: (zone.x - primaryTargetBbox.centerX) * view.scale + view.x,
                    y: (zone.y - primaryTargetBbox.centerY) * view.scale + view.y,
                    radius: zone.radius * view.scale
                };
                const dist = Math.sqrt(Math.pow(p2.x - zoneCanvasSpace.x, 2) + Math.pow(p2.y - zoneCanvasSpace.y, 2));
                if (dist < zoneCanvasSpace.radius) return true;
            }
            return false;
        }

        function updateAndLog(startPoint, endPoint, step, nfzBreach = false) {
            const dx = endPoint.x - startPoint.x, dy = endPoint.y - startPoint.y;
            const distMm = Math.sqrt(dx*dx + dy*dy) / PIXELS_PER_MM;
            const angle = ((Math.atan2(dy, dx) * 180 / Math.PI) + 360) % 360;

            let severity = 'safe';
            if (nfzBreach) severity = 'critical';
            else if (distMm > SEVERITY_THRESHOLDS.warning) severity = 'warning';
            else if (distMm > SEVERITY_THRESHOLDS.caution) severity = 'caution';

            renderState.hud = { distance: `${distMm.toFixed(2)} mm`, angle: `${angle.toFixed(1)}°`, severity: severity };
            renderState.procedureAnalytics.moves++;
            renderState.procedureAnalytics.severities[severity]++;

            const item = document.createElement('li');
            item.className = `movement-log-item log-${severity}`;
            item.innerHTML = `<b>Move ${step}:</b> ${renderState.hud.distance} at ${renderState.hud.angle}.`;
            if (nfzBreach) item.innerHTML += ` <span style="color:${THEME.DANGER}; font-weight:bold;">NFZ BREACH!</span>`;
            logList.appendChild(item);
        }

        function drawHUD() {
            ctx.save();
            ctx.fillStyle = THEME.SURFACE;
            ctx.beginPath();
            ctx.moveTo(0, 0); ctx.lineTo(450, 0); ctx.lineTo(420, 150); ctx.lineTo(0, 150); ctx.closePath();
            ctx.fill();

            ctx.strokeStyle = THEME.SUCCESS;
            ctx.lineWidth = 2;
            ctx.beginPath();
            const ecgY = 40, ecgWidth = 120;
            const heartRate = 70 + Math.sin(Date.now() / 400) * 5;
            const speed = Date.now() / 2;
            for(let i=0; i < ecgWidth; i++) {
                const x = canvas.width - 150 + i;
                const p = (i + speed) % ecgWidth;
                const y_offset = (p > 50 && p < 60) ? -15*Math.sin((p-50)/10 * Math.PI) : (p > 60 && p < 65) ? 5 : 0;
                ctx.lineTo(x, ecgY + y_offset);
            }
            ctx.stroke();
            ctx.fillStyle = THEME.SUCCESS;
            ctx.font = 'bold 20px "Roboto Mono"';
            ctx.fillText(`♥ ${heartRate.toFixed(0)}`, canvas.width - 150, ecgY + 25);

            ctx.fillStyle = renderState.statusColor;
            ctx.textAlign = 'left';
            ctx.font = 'bold 20px "Roboto Mono"';
            ctx.fillText(`STATUS: ${renderState.status}`, 20, 40);

            if(renderState.hud.distance) {
                const severityColors = { safe: THEME.SUCCESS, caution: THEME.WARNING, warning: THEME.DANGER, critical: THEME.DANGER};
                ctx.fillStyle = severityColors[renderState.hud.severity];
                ctx.font = '16px "Roboto Mono"';
                ctx.fillText(`SEVERITY  : ${renderState.hud.severity.toUpperCase()}`, 20, 70);
                ctx.fillStyle = THEME.TEXT_LIGHT;
                ctx.fillText(`LAST MOVE : ${renderState.hud.distance} @ ${renderState.hud.angle}`, 20, 95);
            }
            ctx.restore();
        }

        function drawMeasurementVector(p1, p2, isLast) {
             if (!isLast) {
                ctx.strokeStyle = 'rgba(229, 231, 235, 0.2)';
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
                return;
            }

            const dx = p2.x - p1.x, dy = p2.y - p1.y;
            const angle = Math.atan2(dy, dx);

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p1.y);
            ctx.moveTo(p2.x, p1.y); ctx.lineTo(p2.x, p2.y);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.strokeStyle = THEME.SECONDARY;
            ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();

            ctx.save();
            ctx.translate(p2.x, p2.y);
            ctx.rotate(angle);
            ctx.fillStyle = THEME.SECONDARY;
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-10, -5); ctx.lineTo(-10, 5); ctx.closePath(); ctx.fill();
            ctx.restore();

            ctx.font = '14px "Roboto Mono"';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            ctx.fillStyle = THEME.PRIMARY_LIGHT;
            ctx.fillText(`ΔX: ${(dx / PIXELS_PER_MM).toFixed(1)}mm`, p1.x + dx / 2, p1.y - 15);

            ctx.fillStyle = THEME.ACCENT;
            ctx.save();
            ctx.translate(p2.x + 15, p1.y + dy / 2);
            ctx.rotate(Math.PI / 2);
            ctx.fillText(`ΔY: ${(dy / PIXELS_PER_MM).toFixed(1)}mm`, 0, 0);
            ctx.restore();
        }

        function drawVignette() {
            const gradient = ctx.createRadialGradient(canvas.width/2, canvas.height/2, canvas.width/2-200, canvas.width/2, canvas.height/2, canvas.width/2+100);
            gradient.addColorStop(0, 'rgba(0,0,0,0)');
            gradient.addColorStop(1, 'rgba(0,0,0,0.7)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0,0,canvas.width, canvas.height);
        }

        function drawScanlines() {
            ctx.fillStyle = 'rgba(16, 185, 129, 0.03)';
            ctx.fillRect(0, scanlineY, canvas.width, 4);
        }

        function drawReticle(x, y, progress) {
            const baseRadius = 20;
            const pulseRadius = baseRadius + Math.sin(progress * Math.PI) * 15;
            const lockProgress = Math.min(progress * 2, 1);
            const color = `rgba(239, 68, 68, ${lockProgress})`;
            const weakColor = `rgba(239, 68, 68, ${lockProgress * 0.5})`;

            ctx.strokeStyle = color; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(x, y, pulseRadius, 0, Math.PI * 2); ctx.stroke();
            ctx.strokeStyle = weakColor;
            ctx.beginPath(); ctx.arc(x, y, baseRadius, 0, Math.PI * 2); ctx.stroke();
            const lineLength = baseRadius * 1.5 * lockProgress;
            ctx.beginPath();
            ctx.moveTo(x - lineLength, y); ctx.lineTo(x + lineLength, y);
            ctx.moveTo(x, y - lineLength); ctx.lineTo(x, y + lineLength);
            ctx.stroke();
        }
    </script>
</body>
</html>